---
title: "Significance Tests (Takasugi et al.)"
author: "Kimberly Truong"
date: "11/1/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


### Dataset

This is the underlying data for Fig 4D. We aim to conduct the appropriate statistical test to support the following conclusions: 

#. LbaCas12a creates more edits than SauCas9 and SpyCas9. 
#. Our orthogonal Cas (hybrid) system generates significantly more edits than previous GESTALT systems. 

To do this, we created a dataframe summarizing the average number of edits per barcode in each sample. 

```{r load-data}
numEdits.df <- read.table('data/numEditsperBarcode_byCRISPRSystem.tsv', header=TRUE, sep='\t', row.names='X')
head(numEdits.df, 20)
```

### Normality Test for Single Systems

We first check for normality. Small sample sizes for single-edited systems make it hard to check confidently:

```{r histogram}
Lba.edits <- numEdits.df[which(numEdits.df$condition=='Lba'),]$numEditsperBarcode_wt
Sau.edits <- numEdits.df[which(numEdits.df$condition=='Sau'),]$numEditsperBarcode_wt
Spy.edits <- numEdits.df[which(numEdits.df$condition=='Spy'),]$numEditsperBarcode_wt

par(mfrow=c(1,3))
hist(Lba.edits, breaks=seq(0,4,0.1))
hist(Sau.edits, breaks=seq(0,2.5,0.1))
hist(Spy.edits, breaks=seq(0,2,0.1))

```

``` {r}
par(mfrow=c(1,3))
qqnorm(sort(Lba.edits))
qqline(sort(Lba.edits))

qqnorm(sort(Sau.edits))
qqline(sort(Sau.edits))

qqnorm(sort(Spy.edits))
qqline(sort(Spy.edits))

```
\
Based on these QQ plots, it appears that our observed data are correlated with what we would expect if they were generated by a normal distribution. It's not perfect, of course, but it doesn't look like a bad approximation either. We can further confirm this with the Shapiro-Wilk normality test as it measures the correlation between the data and z-scores from a normal distribution. 

### The Shapiro-Wilk Normality Test 
``` {r}
shapiro.test(Lba.edits)
shapiro.test(Sau.edits)
shapiro.test(Spy.edits)
```

As expected, small sample sizes have little power in rejecting the null hypothesis of normality. We can assume normality.

### Unpaired one-tailed t-test for Single Systems
``` {r}
t.test(Lba.edits, Sau.edits, paired=FALSE, var.equal=FALSE, alternative='greater')
t.test(Lba.edits, Spy.edits, paired=FALSE, var.equal=FALSE, alternative='greater')
```

This supports our first claim of **Lba generating significantly more edits than Sau and Spy.** 

### Normality Test for Hybrid/GESTALT systems 
``` {r, message=FALSE}
library(dplyr)
hybrid.edits <- numEdits.df %>% 
  filter(condition=="ALL") %>% 
  select(numEditsperBarcode_wt)

scgestalt.edits <- numEdits.df %>% 
  filter(condition=="scGESTALT") %>% 
  select(numEditsperBarcode_wt)

gestalt.edits <- numEdits.df %>% 
  filter(condition=="GESTALT") %>%
  select(numEditsperBarcode_wt)

shapiro.test(hybrid.edits$numEditsperBarcode_wt)
shapiro.test(scgestalt.edits$numEditsperBarcode_wt)
shapiro.test(gestalt.edits$numEditsperBarcode_wt)

```

We assume normality under significance level $\alpha = 0.05$. 

``` {r, echo=FALSE, fig.show='hide'}
hist(gestalt.edits$numEditsperBarcode_wt)

qqnorm(gestalt.edits$numEditsperBarcode_wt)
qqline(gestalt.edits$numEditsperBarcode_wt)
```
### Unpaired one-tailed t-test for Hybrid vs. GESTALT systems
``` {r}
t.test(hybrid.edits$numEditsperBarcode_wt, scgestalt.edits$numEditsperBarcode_wt, paired=FALSE, var.equal=FALSE, alternative='greater')
t.test(hybrid.edits$numEditsperBarcode_wt, gestalt.edits$numEditsperBarcode_wt, paired=FALSE, var.equal=FALSE, alternative='greater')

```

We find that **our new hybrid CRISPR-Cas system produces significantly more edits, on average, than previously published GESTALT systems.**

### Analysis of Single-Site Edits 

In our exploration, we computed the mean percentage of indels under each single CRISPR system.
This ended up being the underlying data for Fig 4F. 

``` {r}
singleSiteEdits.df <- read.table('./data/indelRate_byCRISPRsystem.tsv', header=TRUE, sep='\t', row.names='X')
head(singleSiteEdits.df, 10)

Lba.indels <- singleSiteEdits.df[which(singleSiteEdits.df$condition=='Lba'), 'percentIndels']
Sau.indels <- singleSiteEdits.df[which(singleSiteEdits.df$condition=='Sau'), 'percentIndels']
Spy.indels <- singleSiteEdits.df[which(singleSiteEdits.df$condition=='Spy'), 'percentIndels']

shapiro.test(Lba.indels)
shapiro.test(Sau.indels)
shapiro.test(Spy.indels)
```

We assume normality based on the results of the Shapiro-Wilk normality test. 

### Unpaired one-tailed t-test for Single-Site Edits 
``` {r}
t.test(Lba.indels, Sau.indels, paired=FALSE, var.equal=FALSE, alternative='greater')
t.test(Lba.indels, Spy.indels, paired=FALSE, var.equal=FALSE, alternative='greater')

```

We find that **LbaCas12a significantly generates more single-site edits than either SauCas9 or SpyCas9.**


